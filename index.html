<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>What a Wonderful World!</title>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Open+Sans&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />

  <!-- Cloudinary Upload Widget -->
  <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <nav class="navbar">
      <h2>🌍 Wonderful World</h2>
      <button id="toggleMode">🌞</button>
    </nav>
  </header>

  <div class="container">
    <h1>What A Wonderful World</h1>
    <p>Come here to share your wonderful world photos.</p>

    <form id="photoForm">
      <input type="text" id="titleInput" placeholder="Photo Title" required />
      <button id="upload_widget" type="button">Upload Image</button>
      <input type="hidden" id="uploadedImageUrl" />
      <button type="submit">Share Photo</button>
    </form>
  </div>

  <div class="gallery" id="gallery"></div>

  <footer>
    <p>&copy; 2025 What a Wonderful World. Created with ❤️</p>
  </footer>

  <script>
    // 🌐 Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAoxEwV6dNqVndOQqddrCSKBDRilEqeA6g",
      authDomain: "what-a-wonderful-world-20ed7.firebaseapp.com",
      projectId: "what-a-wonderful-world-20ed7",
      storageBucket: "what-a-wonderful-world-20ed7.appspot.com",
      messagingSenderId: "254980145554",
      appId: "1:254980145554:web:707b7b03319b263ae8814b",
      measurementId: "G-KQG30N9446"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const analytics = firebase.analytics();

    const form = document.getElementById('photoForm');
    const gallery = document.getElementById('gallery');
    const titleInput = document.getElementById('titleInput');
    const toggleButton = document.getElementById('toggleMode');

    let userId = localStorage.getItem('userId');
    if (!userId) {
      userId = Date.now().toString() + Math.random().toString(36).substr(2, 5);
      localStorage.setItem('userId', userId);
    }

    const widget = cloudinary.createUploadWidget({
      cloudName: 'duwyexhvj', // your Cloudinary cloud name
      uploadPreset: 'unsigned_preset' // make sure this is an unsigned preset
    }, (error, result) => {
      if (!error && result && result.event === "success") {
        document.getElementById('uploadedImageUrl').value = result.info.secure_url;
        alert("Upload successful!");
      }
    });

    document.getElementById("upload_widget").addEventListener("click", function () {
      widget.open();
    }, false);

    form.addEventListener('submit', async function (e) {
      e.preventDefault();
      const imageUrl = document.getElementById('uploadedImageUrl').value;
      if (!imageUrl) {
        alert('Please upload an image first.');
        return;
      }

      const newPhoto = {
        title: titleInput.value,
        url: imageUrl,
        userId: userId,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        await db.collection('photos').add(newPhoto);
        titleInput.value = '';
        document.getElementById('uploadedImageUrl').value = '';
      } catch (error) {
        console.error('Error adding photo:', error);
      }
    });

    function renderGallery(photos) {
      gallery.innerHTML = '';
      photos.forEach(photo => {
        const wrapper = document.createElement('div');
        wrapper.classList.add('photo-wrapper');

        const img = document.createElement('img');
        img.src = photo.url;
        img.alt = photo.title;

        const caption = document.createElement('p');
        caption.textContent = photo.title;

        wrapper.appendChild(img);
        wrapper.appendChild(caption);

        if (photo.userId === userId) {
          const btn = document.createElement('button');
          btn.textContent = '🗑️ Delete';
          btn.className = 'delete-button';
          btn.addEventListener('click', async () => {
            try {
              await db.collection('photos').doc(photo.id).delete();
            } catch (error) {
              console.error('Error deleting photo:', error);
            }
          });
          wrapper.appendChild(btn);
        }

        gallery.appendChild(wrapper);
      });
    }

    db.collection('photos').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
      const photoList = [];
      snapshot.forEach(doc => photoList.push({ id: doc.id, ...doc.data() }));
      renderGallery(photoList);
    });

    toggleButton.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      toggleButton.textContent = document.body.classList.contains('dark') ? '🌙' : '🌞';
    });
  </script>
</body>
</html>
